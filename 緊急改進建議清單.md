# å¿ƒç†æ²»ç™‚ç³»çµ±ç·Šæ€¥æ”¹é€²å»ºè­°æ¸…å–®

## ğŸš¨ ç«‹å³ä¿®å¾©é …ç›®ï¼ˆ1-2é€±å…§ï¼‰

### 1. è³‡æ–™å®‰å…¨æ¼æ´ ğŸ”´ **æ¥µé«˜å„ªå…ˆç´š**

#### å•é¡Œï¼šæ•æ„Ÿé†«ç™‚è³‡æ–™æœªåŠ å¯†
```javascript
// ç•¶å‰å•é¡Œï¼šappointments.notes å¯èƒ½åŒ…å«æ•æ„Ÿæ²»ç™‚è³‡è¨Šï¼Œä½†æœªåŠ å¯†
// é¢¨éšªï¼šè³‡æ–™åº«æ´©éœ²æ™‚ï¼Œæ‚£è€…éš±ç§å®Œå…¨æš´éœ²

// å»ºè­°ç«‹å³å¯¦æ–½ï¼š
// 1. å®‰è£åŠ å¯†å¥—ä»¶
npm install node-forge

// 2. å‰µå»ºåŠ å¯†å·¥å…·é¡
// utils/encryption.js
const forge = require('node-forge');

class MedicalDataEncryption {
  constructor() {
    this.key = process.env.ENCRYPTION_KEY || 'your-32-character-key-here!!!';
    this.iv = forge.random.getBytesSync(16);
  }
  
  encrypt(data) {
    if (!data) return null;
    const cipher = forge.cipher.createCipher('AES-CBC', this.key);
    cipher.start({iv: this.iv});
    cipher.update(forge.util.createBuffer(data));
    cipher.finish();
    return forge.util.encode64(this.iv + cipher.output.getBytes());
  }
  
  decrypt(encryptedData) {
    if (!encryptedData) return null;
    const decoded = forge.util.decode64(encryptedData);
    const iv = decoded.slice(0, 16);
    const encrypted = decoded.slice(16);
    const decipher = forge.cipher.createDecipher('AES-CBC', this.key);
    decipher.start({iv: iv});
    decipher.update(forge.util.createBuffer(encrypted));
    decipher.finish();
    return decipher.output.toString();
  }
}

// 3. ä¿®æ”¹ appointmentController.js
const encryption = new MedicalDataEncryption();

// åœ¨å‰µå»ºé ç´„æ™‚åŠ å¯†å‚™è¨»
const encryptedNotes = encryption.encrypt(note);

// åœ¨æŸ¥è©¢æ™‚è§£å¯†å‚™è¨»
const decryptedNotes = encryption.decrypt(appointment.notes);
```

### 2. SQL æ³¨å…¥é˜²è­·å¼·åŒ– ğŸ”´ **æ¥µé«˜å„ªå…ˆç´š**

#### å•é¡Œï¼šéƒ¨åˆ†æŸ¥è©¢å¯èƒ½å­˜åœ¨ SQL æ³¨å…¥é¢¨éšª
```javascript
// æª¢æŸ¥ä¸¦ä¿®å¾©æ‰€æœ‰å‹•æ…‹ SQL æŸ¥è©¢
// ä¾‹å¦‚åœ¨ scheduleController.js ä¸­çš„æ’åºåŠŸèƒ½

// âŒ å±éšªçš„åšæ³•ï¼š
const query = `SELECT * FROM appointments ORDER BY ${sortBy} ${sortOrder}`;

// âœ… å®‰å…¨çš„åšæ³•ï¼š
const allowedSortFields = ['date', 'time', 'status', 'created_at'];
const allowedSortOrders = ['ASC', 'DESC'];

if (!allowedSortFields.includes(sortBy)) {
  throw new Error('Invalid sort field');
}
if (!allowedSortOrders.includes(sortOrder.toUpperCase())) {
  throw new Error('Invalid sort order');
}

const query = `SELECT * FROM appointments ORDER BY ${sortBy} ${sortOrder}`;
```

### 3. å¯†ç¢¼æ”¿ç­–å¼·åŒ– ğŸ”´ **é«˜å„ªå…ˆç´š**

#### å•é¡Œï¼šç•¶å‰å¯†ç¢¼æ”¿ç­–éæ–¼å¯¬é¬†
```javascript
// ä¿®æ”¹ utils/validators.js
const validatePassword = (password) => {
  const minLength = 12;
  const hasUpperCase = /[A-Z]/.test(password);
  const hasLowerCase = /[a-z]/.test(password);
  const hasNumbers = /\d/.test(password);
  const hasSpecialChar = /[!@#$%^&*(),.?":{}|<>]/.test(password);
  
  if (password.length < minLength) {
    return { isValid: false, error: 'å¯†ç¢¼é•·åº¦è‡³å°‘éœ€è¦12ä½å­—ç¬¦' };
  }
  
  if (!hasUpperCase || !hasLowerCase || !hasNumbers || !hasSpecialChar) {
    return { 
      isValid: false, 
      error: 'å¯†ç¢¼å¿…é ˆåŒ…å«å¤§å¯«å­—æ¯ã€å°å¯«å­—æ¯ã€æ•¸å­—å’Œç‰¹æ®Šå­—ç¬¦' 
    };
  }
  
  return { isValid: true };
};
```

### 4. API è¼¸å…¥é©—è­‰æ¼æ´ ğŸ”´ **é«˜å„ªå…ˆç´š**

#### å•é¡Œï¼šç¼ºä¹å®Œæ•´çš„è¼¸å…¥é©—è­‰
```javascript
// å®‰è£é©—è­‰å¥—ä»¶
npm install joi

// å‰µå»ºé©—è­‰æ¨¡å¼
const Joi = require('joi');

const appointmentValidationSchema = Joi.object({
  doctorId: Joi.number().integer().positive().required(),
  patientId: Joi.number().integer().positive().required(),
  appointmentDate: Joi.date().min('now').required(),
  timeSlot: Joi.string().pattern(/^([01]?[0-9]|2[0-3]):[0-5][0-9]$/).required(),
  notes: Joi.string().max(2000).allow(''),
  patientInfo: Joi.object({
    patientName: Joi.string().max(100).required(),
    isActualPatient: Joi.boolean().required()
  }).optional()
});

// åœ¨æ§åˆ¶å™¨ä¸­ä½¿ç”¨
const { error } = appointmentValidationSchema.validate(req.body);
if (error) {
  return res.status(400).json({ 
    success: false, 
    error: error.details[0].message 
  });
}
```

---

## âš ï¸ é‡è¦ä¿®å¾©é …ç›®ï¼ˆ2-4é€±å…§ï¼‰

### 5. å¯©è¨ˆæ—¥èªŒç³»çµ± ğŸŸ¡ **é«˜å„ªå…ˆç´š**

#### å•é¡Œï¼šç„¡æ³•è¿½è¹¤æ•æ„Ÿæ“ä½œ
```sql
-- å‰µå»ºå¯©è¨ˆè¡¨
CREATE TABLE audit_logs (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER,
  action TEXT NOT NULL,
  resource_type TEXT,
  resource_id TEXT,
  old_values TEXT,
  new_values TEXT,
  ip_address TEXT,
  user_agent TEXT,
  session_id TEXT,
  timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id)
);

-- å‰µå»ºæ•æ„Ÿæ“ä½œè§¸ç™¼å™¨
CREATE TRIGGER audit_appointments_update
AFTER UPDATE ON appointments
FOR EACH ROW
BEGIN
  INSERT INTO audit_logs (
    user_id, action, resource_type, resource_id, 
    old_values, new_values, timestamp
  ) VALUES (
    NEW.updated_by, 'UPDATE', 'appointment', NEW.id,
    json_object('status', OLD.status, 'notes', OLD.notes),
    json_object('status', NEW.status, 'notes', NEW.notes),
    datetime('now')
  );
END;
```

### 6. æœƒè©±å®‰å…¨å¼·åŒ– ğŸŸ¡ **ä¸­é«˜å„ªå…ˆç´š**

#### å•é¡Œï¼šJWT token å®‰å…¨æ€§ä¸è¶³
```javascript
// ä¿®æ”¹ middlewares/auth.js
const jwt = require('jsonwebtoken');
const crypto = require('crypto');

// 1. å¯¦æ–½ token é»‘åå–®
const tokenBlacklist = new Set();

// 2. ç¸®çŸ­ token æœ‰æ•ˆæœŸ
const generateToken = (user) => {
  return jwt.sign(
    { 
      id: user.id, 
      email: user.email, 
      role: user.role,
      sessionId: crypto.randomUUID() // æ–°å¢æœƒè©±ID
    },
    JWT_SECRET,
    { 
      expiresIn: '2h', // å¾24å°æ™‚ç¸®çŸ­åˆ°2å°æ™‚
      issuer: 'therapy-system',
      audience: 'therapy-users'
    }
  );
};

// 3. å¯¦æ–½ token åˆ·æ–°æ©Ÿåˆ¶
const refreshToken = (req, res) => {
  const { token } = req.body;
  
  try {
    const decoded = jwt.verify(token, JWT_SECRET);
    const newToken = generateToken(decoded);
    res.json({ success: true, token: newToken });
  } catch (error) {
    res.status(401).json({ success: false, error: 'ç„¡æ•ˆçš„ä»¤ç‰Œ' });
  }
};
```

### 7. API é™æµæ©Ÿåˆ¶ ğŸŸ¡ **ä¸­å„ªå…ˆç´š**

#### å•é¡Œï¼šç¼ºä¹é˜²æ­¢æš´åŠ›æ”»æ“Šçš„æ©Ÿåˆ¶
```javascript
// å®‰è£é™æµå¥—ä»¶
npm install express-rate-limit express-slow-down

const rateLimit = require('express-rate-limit');
const slowDown = require('express-slow-down');

// 1. ç™»å…¥é™æµ
const loginLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 åˆ†é˜
  max: 5, // æœ€å¤š 5 æ¬¡å˜—è©¦
  message: {
    success: false,
    error: 'ç™»å…¥å˜—è©¦æ¬¡æ•¸éå¤šï¼Œè«‹ 15 åˆ†é˜å¾Œå†è©¦'
  },
  standardHeaders: true,
  legacyHeaders: false,
});

// 2. API è¨ªå•é™æµ
const apiLimiter = rateLimit({
  windowMs: 1 * 60 * 1000, // 1 åˆ†é˜
  max: 100, // æ¯åˆ†é˜æœ€å¤š 100 å€‹è«‹æ±‚
  message: {
    success: false,
    error: 'API è«‹æ±‚éæ–¼é »ç¹ï¼Œè«‹ç¨å¾Œå†è©¦'
  }
});

// 3. ç·©æ…¢éŸ¿æ‡‰æ”»æ“Šé˜²è­·
const speedLimiter = slowDown({
  windowMs: 15 * 60 * 1000, // 15 åˆ†é˜
  delayAfter: 50, // 50 å€‹è«‹æ±‚å¾Œé–‹å§‹å»¶é²
  delayMs: 500 // æ¯å€‹è«‹æ±‚å»¶é² 500ms
});

// æ‡‰ç”¨åˆ°è·¯ç”±
app.use('/api/auth/login', loginLimiter);
app.use('/api/', apiLimiter);
app.use('/api/', speedLimiter);
```

---

## ğŸ”§ åŠŸèƒ½å¢å¼·é …ç›®ï¼ˆ1-2æœˆå…§ï¼‰

### 8. æ²»ç™‚è¨˜éŒ„ç³»çµ± ğŸŸ¢ **ä¸­å„ªå…ˆç´š**

#### å•é¡Œï¼šç¼ºä¹å°ˆæ¥­æ²»ç™‚è¨˜éŒ„åŠŸèƒ½
```sql
-- æ²»ç™‚æœƒè«‡è¨˜éŒ„è¡¨
CREATE TABLE therapy_sessions (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  appointment_id INTEGER NOT NULL,
  session_number INTEGER,
  session_type TEXT CHECK(session_type IN ('individual', 'group', 'family', 'couple')),
  duration_minutes INTEGER,
  
  -- æ²»ç™‚å…§å®¹ï¼ˆåŠ å¯†ï¼‰
  presenting_issues TEXT, -- ä¸»è¨´å•é¡Œ
  session_notes TEXT, -- æœƒè«‡è¨˜éŒ„
  interventions_used TEXT, -- ä½¿ç”¨çš„å¹²é æ–¹æ³•
  homework_assigned TEXT, -- æŒ‡æ´¾çš„ä½œæ¥­
  next_session_goals TEXT, -- ä¸‹æ¬¡æœƒè«‡ç›®æ¨™
  
  -- è©•ä¼°
  mood_rating INTEGER CHECK(mood_rating BETWEEN 1 AND 10),
  anxiety_rating INTEGER CHECK(anxiety_rating BETWEEN 1 AND 10),
  progress_rating INTEGER CHECK(progress_rating BETWEEN 1 AND 10),
  risk_assessment TEXT CHECK(risk_assessment IN ('low', 'medium', 'high', 'crisis')),
  
  -- å…ƒè³‡æ–™
  therapist_id INTEGER NOT NULL,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  
  FOREIGN KEY (appointment_id) REFERENCES appointments(id),
  FOREIGN KEY (therapist_id) REFERENCES users(id)
);
```

### 9. é¢¨éšªè©•ä¼°ç³»çµ± ğŸŸ¢ **ä¸­å„ªå…ˆç´š**

#### å•é¡Œï¼šç¼ºä¹è‡ªæ®º/è‡ªå‚·é¢¨éšªè©•ä¼°
```javascript
// å‰µå»ºé¢¨éšªè©•ä¼°æ§åˆ¶å™¨
class RiskAssessmentController {
  static async createAssessment(req, res) {
    const { 
      patientId, 
      suicidalIdeation, 
      selfHarmRisk, 
      substanceUse,
      socialSupport,
      stressors 
    } = req.body;
    
    // è¨ˆç®—é¢¨éšªåˆ†æ•¸
    const riskScore = this.calculateRiskScore({
      suicidalIdeation,
      selfHarmRisk,
      substanceUse,
      socialSupport,
      stressors
    });
    
    // å¦‚æœæ˜¯é«˜å±éšªï¼Œè§¸ç™¼è­¦å ±
    if (riskScore >= 8) {
      await this.triggerCrisisProtocol(patientId, req.user.id);
    }
    
    // å„²å­˜è©•ä¼°çµæœ
    const assessment = await this.saveAssessment({
      patientId,
      riskScore,
      details: req.body,
      assessedBy: req.user.id
    });
    
    res.json({ success: true, assessment, riskLevel: this.getRiskLevel(riskScore) });
  }
  
  static calculateRiskScore(factors) {
    let score = 0;
    if (factors.suicidalIdeation) score += 4;
    if (factors.selfHarmRisk) score += 3;
    if (factors.substanceUse) score += 2;
    if (!factors.socialSupport) score += 2;
    if (factors.stressors) score += 1;
    return score;
  }
  
  static getRiskLevel(score) {
    if (score >= 8) return 'crisis';
    if (score >= 6) return 'high';
    if (score >= 3) return 'medium';
    return 'low';
  }
  
  static async triggerCrisisProtocol(patientId, therapistId) {
    // ç™¼é€ç·Šæ€¥é€šçŸ¥
    // è¨˜éŒ„å±æ©Ÿäº‹ä»¶
    // å¯èƒ½éœ€è¦è‡ªå‹•è¯ç¹«ç·Šæ€¥è¯çµ¡äºº
  }
}
```

### 10. å¤šå› å­é©—è­‰ï¼ˆMFAï¼‰ğŸŸ¢ **ä¸­å„ªå…ˆç´š**

#### å•é¡Œï¼šèº«ä»½é©—è­‰å¼·åº¦ä¸è¶³
```javascript
// å®‰è£ MFA å¥—ä»¶
npm install speakeasy qrcode

const speakeasy = require('speakeasy');
const qrcode = require('qrcode');

class MFAController {
  static async enableMFA(req, res) {
    const secret = speakeasy.generateSecret({
      name: `å¿ƒç†æ²»ç™‚ç³»çµ±:${req.user.email}`,
      issuer: 'å¿ƒç†æ²»ç™‚ç³»çµ±'
    });
    
    // ç”Ÿæˆ QR ç¢¼
    const qrCodeUrl = await qrcode.toDataURL(secret.otpauth_url);
    
    // æš«å­˜ secretï¼ˆç”¨æˆ¶ç¢ºèªå¾Œå†æ­£å¼å•Ÿç”¨ï¼‰
    req.session.tempMFASecret = secret.base32;
    
    res.json({
      success: true,
      qrCode: qrCodeUrl,
      secret: secret.base32
    });
  }
  
  static async verifyMFA(req, res) {
    const { token } = req.body;
    const secret = req.session.tempMFASecret || req.user.mfaSecret;
    
    const verified = speakeasy.totp.verify({
      secret: secret,
      encoding: 'base32',
      token: token,
      window: 1
    });
    
    if (verified) {
      if (req.session.tempMFASecret) {
        // é¦–æ¬¡è¨­å®šï¼Œå„²å­˜åˆ°ç”¨æˆ¶å¸³æˆ¶
        await this.saveMFASecret(req.user.id, secret);
        delete req.session.tempMFASecret;
      }
      res.json({ success: true, message: 'MFA é©—è­‰æˆåŠŸ' });
    } else {
      res.status(400).json({ success: false, error: 'MFA é©—è­‰å¤±æ•—' });
    }
  }
}
```

---

## ğŸ“‹ æª¢æŸ¥æ¸…å–®

### ç«‹å³åŸ·è¡Œï¼ˆæœ¬é€±ï¼‰âœ…
- [ ] å¯¦æ–½æ•æ„Ÿè³‡æ–™åŠ å¯†
- [ ] å¼·åŒ–å¯†ç¢¼æ”¿ç­–
- [ ] æ–°å¢ API è¼¸å…¥é©—è­‰
- [ ] ä¿®å¾©æ½›åœ¨çš„ SQL æ³¨å…¥é¢¨éšª

### çŸ­æœŸåŸ·è¡Œï¼ˆ2-4é€±ï¼‰âœ…
- [ ] å»ºç«‹å¯©è¨ˆæ—¥èªŒç³»çµ±
- [ ] å¯¦æ–½ API é™æµæ©Ÿåˆ¶
- [ ] å¼·åŒ–æœƒè©±å®‰å…¨
- [ ] æ–°å¢éŒ¯èª¤ç›£æ§å’Œå‘Šè­¦

### ä¸­æœŸåŸ·è¡Œï¼ˆ1-2æœˆï¼‰âœ…
- [ ] é–‹ç™¼æ²»ç™‚è¨˜éŒ„ç³»çµ±
- [ ] å¯¦æ–½é¢¨éšªè©•ä¼°åŠŸèƒ½
- [ ] éƒ¨ç½²å¤šå› å­é©—è­‰
- [ ] å»ºç«‹å‚™ä»½å’Œç½é›£æ¢å¾©æ©Ÿåˆ¶

---

## ğŸš¨ é¢¨éšªè©•ä¼°

| é¢¨éšªé …ç›® | ç•¶å‰é¢¨éšªç´šåˆ¥ | ä¿®å¾©å¾Œé¢¨éšªç´šåˆ¥ | ç·Šæ€¥ç¨‹åº¦ |
|---------|-------------|---------------|---------|
| è³‡æ–™æ´©éœ² | ğŸ”´ æ¥µé«˜ | ğŸŸ¢ ä½ | ç«‹å³ |
| æœªæˆæ¬Šå­˜å– | ğŸ”´ é«˜ | ğŸŸ¡ ä¸­ | 1é€±å…§ |
| ç³»çµ±å¯ç”¨æ€§ | ğŸŸ¡ ä¸­ | ğŸŸ¢ ä½ | 2é€±å…§ |
| åˆè¦æ€§é¢¨éšª | ğŸ”´ æ¥µé«˜ | ğŸŸ¡ ä¸­ | 1å€‹æœˆå…§ |

## ğŸ’° å¯¦æ–½æˆæœ¬ä¼°ç®—

- **ç¬¬ä¸€éšæ®µï¼ˆå®‰å…¨ä¿®å¾©ï¼‰**: 80-120 å°æ™‚é–‹ç™¼æ™‚é–“
- **ç¬¬äºŒéšæ®µï¼ˆåŠŸèƒ½å¢å¼·ï¼‰**: 160-240 å°æ™‚é–‹ç™¼æ™‚é–“  
- **ç¬¬ä¸‰éšæ®µï¼ˆåˆè¦å„ªåŒ–ï¼‰**: 120-180 å°æ™‚é–‹ç™¼æ™‚é–“

**ç¸½è¨ˆ**: 360-540 å°æ™‚ï¼ˆç´„ 9-14 é€±çš„å…¨è·é–‹ç™¼æ™‚é–“ï¼‰

é€™ä»½æ¸…å–®ç‚ºæ‚¨æä¾›äº†æ˜ç¢ºçš„æ”¹é€²è·¯å¾‘ï¼Œå»ºè­°ç«‹å³é–‹å§‹å¯¦æ–½ç¬¬ä¸€éšæ®µçš„å®‰å…¨ä¿®å¾©ï¼Œä»¥ä¿è­·æ‚£è€…éš±ç§å’Œç³»çµ±å®‰å…¨ã€‚ 