# Zeabur 部署持久化測試計畫

此文件提供一個完整的測試計畫，用於驗證在 Zeabur 上部署應用程式更新後，SQLite 資料庫是否能正確保持持久性。

## 測試前準備

1. 確保 Zeabur 專案已配置好持久化卷：
   - 已創建持久化卷 (Volume)，並掛載到 `/data` 目錄
   - 已設置環境變數 `DB_PATH` 為 `/data/database.sqlite`

2. 準備一個小的程式碼修改（不影響資料庫結構），例如：
   - 修改 `/api/health` 端點中的版本號
   - 在日誌輸出中添加新的訊息
   - 更改 API 回應中的某些訊息文本

## 測試步驟

### 步驟 1: 備份當前資料庫（安全措施）

```bash
# 在部署前執行
npm run db:backup
```

### 步驟 2: 創建獨特的測試資料

```bash
# 創建測試資料
npm run test:create-data
```

執行此命令後，記錄下創建的測試用戶 Email 及其他資訊，這將在後續驗證中需要。

### 步驟 3: 部署程式碼更新

1. 將修改過的程式碼推送到版本控制系統（例如 GitHub）
2. 在 Zeabur 控制台中觸發重新部署（或等待自動部署）
3. 確認新版本已成功部署（可以通過訪問 `/api/health` 端點確認版本號變化）

### 步驟 4: 驗證資料持久性

```bash
# 提供步驟 2 中記錄的測試用戶 Email
npm run test:verify-data <測試用戶Email>
```

如果命令成功執行，並顯示「資料庫持久性測試結果: 成功 ✓」，則表示資料庫持久性配置正確。

## 持久性測試詳解

### 測試原理

本測試的核心邏輯是：
1. 在部署前創建具有時間戳的獨特資料
2. 執行部署更新
3. 在部署後驗證這些獨特資料是否依然存在

### 可能的問題與解決方案

1. **資料遺失**：如果驗證失敗且資料丟失，檢查：
   - Zeabur 持久化卷是否正確配置
   - 環境變數 `DB_PATH` 是否正確設置
   - 持久化卷的權限是否正確

2. **應用程式無法啟動**：檢查：
   - 日誌輸出，查找可能的錯誤
   - 確認環境變數是否正確配置
   - 確認持久化卷是否成功掛載

3. **資料庫路徑問題**：如果應用程式運行，但使用了錯誤的資料庫路徑：
   - 檢查 `server.js` 中的 `dbPath` 輸出日誌
   - 確認環境變數 `DB_PATH` 被正確讀取
   - 確認應用程式的工作目錄正確

## 定期持久性驗證

建議在每次重要更新後執行此測試流程，以確保持久化配置一直有效。

此外，考慮設置自動備份機制，例如：
- 使用 Zeabur 的定時任務（如果支援）
- 設置外部服務定期觸發備份
- 實施自動化測試以驗證持久性

## 恢復計畫

如果持久性驗證失敗，且資料已丟失，可以使用之前的備份恢復：

```bash
# 使用最近的備份還原
npm run db:restore <最近的備份檔案名>
```

記得在解決持久性問題後，重新測試持久性配置。 